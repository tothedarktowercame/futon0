# Futon Services - nginx TLS termination
# Copy to /etc/nginx/sites-available/ and symlink to sites-enabled/
#
# Requires: Let's Encrypt certs (see README-setup.md)
# Replace 172-236-28-208.ip.linodeusercontent.com with actual domain

# Forum / Transport WebSocket (WSS)
server {
    listen 5051 ssl;
    server_name 172-236-28-208.ip.linodeusercontent.com;

    ssl_certificate /etc/letsencrypt/live/172-236-28-208.ip.linodeusercontent.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/172-236-28-208.ip.linodeusercontent.com/privkey.pem;

    # WebSocket support
    location / {
        proxy_pass http://127.0.0.1:5050;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for long-lived connections
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
}

# Agency HTTPS (7073 ssl -> 7070 plain; 7071 reserved for futon1a dev)
server {
    listen 7073 ssl;
    server_name 172-236-28-208.ip.linodeusercontent.com;

    ssl_certificate /etc/letsencrypt/live/172-236-28-208.ip.linodeusercontent.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/172-236-28-208.ip.linodeusercontent.com/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:7070;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Lab WebSocket (WSS) - SSL termination for lab-ws
server {
    listen 5057 ssl;
    server_name 172-236-28-208.ip.linodeusercontent.com;

    ssl_certificate /etc/letsencrypt/live/172-236-28-208.ip.linodeusercontent.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/172-236-28-208.ip.linodeusercontent.com/privkey.pem;

    # WebSocket support
    location / {
        proxy_pass http://127.0.0.1:5056;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for long-lived connections
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
}
